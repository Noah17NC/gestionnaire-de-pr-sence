<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion de Présence</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; }
    .header, .footer { background-color: #007bff; color: white; padding: 10px 0; text-align: center; }
    table { width: 100%; margin: auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background-color: #0056b3; color: white; }
    .present { background-color: #d4edda !important; }
    .absent { background-color: #f8d7da !important; }
    #menu, #table-container, #schedule-container { display: none; }
    #menu img { display: block; margin: 20px auto; max-width: 200px; }
    #groupSelect { margin-left: 20px; }
    .container { margin-top: 20px; }
    .text-center { text-align: center; }
    #barcodeInput { outline: none; }
    .video-container { position: relative; display: inline-block; }
    #overlay { position: absolute; top: 0; left: 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Gestion de Présence</h1>
  </div>

  <div class="container">
    <!-- Input fichier Excel -->
    <div class="text-center mb-4">
      <input type="file" id="fileInput" accept=".xlsx, .xls" class="form-control-file">
    </div>

    <!-- Menu classes -->
    <div id="menu" class="text-center">
      <img src="https://www.agripedia.nc/sites/default/files/2023-01/Lyce%CC%81e%20Mont%20Dore.jpg" alt="Logo du Lycée" class="img-fluid mb-3">
      <h2>Sélectionnez une Classe</h2>
      <select id="classSelect" class="form-control d-inline-block w-auto mb-2">
        <option value="">-- Sélectionnez une classe --</option>
      </select>
      <button class="btn btn-primary" onclick="showClass()">Afficher la Classe</button>
    </div>

    <!-- Emploi du temps -->
    <div id="schedule-container"></div>

    <!-- Tableau élèves -->
    <div id="table-container">
      <h3 id="classTitle" class="text-center mb-4"></h3>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Code-Barres</th>
            <th>Présence</th>
          </tr>
        </thead>
        <tbody id="studentTable"></tbody>
      </table>

      <div class="text-center mb-4">
        <input type="text" id="barcodeInput" class="form-control w-auto d-inline-block" placeholder="Scannez le code-barres ici" tabindex="0" autofocus>
        <select id="groupSelect" class="form-control d-inline-block w-auto ml-2">
          <option value="all">Tous les élèves</option>
        </select>
        <button class="btn btn-success ml-2" onclick="validerAppel()">Valider l'Appel</button>
        <button class="btn btn-secondary ml-2" onclick="showMenu()">Revenir au Menu</button>
      </div>

      <!-- Webcam et bouton activer -->
      <div class="text-center mb-3 video-container">
        <button id="startCam" class="btn btn-primary">Activer la caméra</button>
        <video id="video" autoplay muted width="320" height="240"></video>
        <canvas id="overlay" width="320" height="240"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>&copy; 2024 Gestion de Présence</p>
  </div>

  <!-- Librairies externes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    let classes = {};
    let currentClass = null;
    let currentGroup = 'all';
    let schedule = [];

    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('startCam');
    let faceMatcher = null;

    // ---------------- Gestion Excel ----------------
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e){
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data,{type:'array'});
        processWorkbook(workbook);
      };
      reader.readAsArrayBuffer(file);
    }

    function processWorkbook(workbook){
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet,{header:1});
      let currentClassName=null, currentGroupName=null;
      jsonData.forEach(row=>{
        if(row[0] && row[0].toLowerCase().startsWith('classe')){
          currentClassName=row[0]; classes[currentClassName]={};
        } else if(row[0] && row[0].toLowerCase().startsWith('groupe')){
          currentGroupName=row[0]; classes[currentClassName][currentGroupName]=[];
        } else if(currentClassName && currentGroupName){
          classes[currentClassName][currentGroupName].push({
            name: row[0],
            id: row[1] ? row[1].toString().trim() : '',
            present: false
          });
        }
      });

      const scheduleSheet = workbook.Sheets['Emploi du Temps'];
      if(scheduleSheet) schedule = XLSX.utils.sheet_to_json(scheduleSheet,{header:1});

      populateClassSelect();
      showMenu();
    }

    function populateClassSelect(){
      const select = document.getElementById('classSelect');
      select.innerHTML='<option value="">-- Sélectionnez une classe --</option>';
      Object.keys(classes).forEach(c=>{
        const option=document.createElement('option');
        option.value=c; option.textContent=c;
        select.appendChild(option);
      });
    }

    function populateGroupSelect(){
      const select = document.getElementById('groupSelect');
      select.innerHTML='<option value="all">Tous les élèves</option>';
      Object.keys(classes[currentClass]).forEach(g=>{
        const option=document.createElement('option');
        option.value=g; option.textContent=g;
        select.appendChild(option);
      });
    }

    function showMenu(){ 
      document.getElementById('menu').style.display='block'; 
      document.getElementById('table-container').style.display='none'; 
    }

    function showClass(){
      const selected = document.getElementById('classSelect').value;
      if(selected){
        currentClass = selected;
        currentGroup = 'all';
        document.getElementById('classTitle').textContent = selected;
        populateGroupSelect();
        updateTable();
        displaySchedule();
        document.getElementById('menu').style.display='none';
        document.getElementById('table-container').style.display='block';
        focusBarcodeInput();
        btn.style.display='inline-block';
      }
    }

    function updateTable(){
      const table = document.getElementById('studentTable');
      table.innerHTML='';
      const groups = classes[currentClass];
      const students = currentGroup==='all'? Object.values(groups).flat() : groups[currentGroup];
      students.forEach((s,i)=>{
        const row = document.createElement('tr');
        row.classList.toggle('present',s.present);
        row.classList.toggle('absent',!s.present);
        row.innerHTML=`<td>${s.name}</td><td>${s.id}</td>
          <td><input type="checkbox" ${s.present?'checked':''} data-index="${i}" onchange="togglePresence(this)"></td>`;
        table.appendChild(row);
      });
      focusBarcodeInput();
    }

    // Gestion du changement de groupe
    document.getElementById('groupSelect').addEventListener('change', (e)=>{
      currentGroup = e.target.value;
      updateTable();
    });

    function displaySchedule(){
      const sc = document.getElementById('schedule-container');
      sc.innerHTML='';
      if(schedule.length>0){
        const table=document.createElement('table');
        table.classList.add('table','table-bordered','table-striped');
        let header='<thead><tr><th>Heure</th>';
        schedule[0].forEach((_,i)=>{ if(i>0) header+=`<th>${schedule[0][i]}</th>` });
        header+='</tr></thead>';
        table.innerHTML=header;
        for(let i=1;i<schedule.length;i++){
          let row='<tr>';
          schedule[i].forEach(cell=>row+=`<td>${cell}</td>`);
          row+='</tr>'; table.innerHTML+=row;
        }
        sc.appendChild(table);
      }
    }

    function togglePresence(cb){
      const index = cb.dataset.index;
      const students = currentGroup==='all'? Object.values(classes[currentClass]).flat() : classes[currentClass][currentGroup];
      students[index].present = cb.checked;
      updateTable();
    }

    function focusBarcodeInput(){ document.getElementById('barcodeInput').focus(); }

    // ---------------- Face API avec labels ----------------
    async function loadModels() {
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('models')
      ]);
      console.log("✅ Modèles chargés");
    }

    async function loadLabeledImages() {
      if (!currentClass) return [];
      const labels = Object.values(classes[currentClass]).flat().map(s=>s.name);
      return Promise.all(labels.map(async label=>{
        try {
          const imgUrl = `known_faces/${label}.jpg`;
          const img = await faceapi.fetchImage(imgUrl);
          const detection = await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();
          if(!detection) throw new Error(`Aucun visage détecté pour ${label}`);
          return new faceapi.LabeledFaceDescriptors(label,[detection.descriptor]);
        } catch(err) {
          console.warn(`❌ ${label} ignoré : ${err.message}`);
          return null;
        }
      })).then(results=>results.filter(Boolean));
    }

    async function startRecognition(){
      await loadModels();
      const labeledDescriptors = await loadLabeledImages();
      faceMatcher = new faceapi.FaceMatcher(labeledDescriptors,0.6);
      console.log("✅ Visages connus chargés :", labeledDescriptors.map(ld=>ld.label));

      const stream = await navigator.mediaDevices.getUserMedia({ video:{} });
      video.srcObject = stream;

      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(canvas, displaySize);

      video.addEventListener('play', ()=>{
        setInterval(async ()=>{
          const detections = await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptors();

          const resized = faceapi.resizeResults(detections, displaySize);
          ctx.clearRect(0,0,canvas.width,canvas.height);

          resized.forEach(d=>{
            const bestMatch = faceMatcher.findBestMatch(d.descriptor);
            const drawBox = new faceapi.draw.DrawBox(d.detection.box,{label:bestMatch.toString()});
            drawBox.draw(canvas);

            if(bestMatch.label!=='unknown') markPresent(bestMatch.label);
          });
        },500);
      });
    }

    function markPresent(name){
      Object.values(classes[currentClass]).flat().flat().forEach(s=>{
        if(s.name===name) s.present=true;
      });
      updateTable();
    }

    btn.addEventListener('click', ()=>{
      btn.style.display='none';
      startRecognition();
    });

    function validerAppel(){ alert('Présences validées !'); }

  </script>
</body>
</html>
